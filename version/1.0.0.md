ä»¥ä¸‹æ˜¯å¯¹è¿™æ®µ Rust ä»£ç çš„è¯¦ç»†è§£é‡Šï¼ˆä¸€ä¸ªå®Œæ•´çš„ã€åŸºäº libp2p å’Œ Actix-Web çš„ P2P èŠ‚ç‚¹ç¨‹åºï¼‰ï¼š

---

## ğŸ§  æ•´ä½“æ¶æ„æ¦‚è¿°

è¯¥ç¨‹åºæ„å»ºäº†ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„ **libp2p ç‚¹å¯¹ç‚¹èŠ‚ç‚¹**ï¼Œå¹¶ä¸ºå…¶æ·»åŠ äº† HTTP æ¥å£ç”¨äºæŸ¥è¯¢è¿è¡ŒçŠ¶æ€ã€‚å®ƒç»“åˆäº†ä»¥ä¸‹å‡ ä¸ªå…³é”®æŠ€æœ¯ç»„ä»¶ï¼š

1. **libp2p-rs ç”Ÿæ€åº“**ï¼šå®ç° P2P ç½‘ç»œé€šä¿¡ï¼›
2. **async/await + tokio**ï¼šæ”¯æŒå¼‚æ­¥äº‹ä»¶é©±åŠ¨ï¼›
3. **Actix-Web**ï¼šæä¾› HTTP æ¥å£æœåŠ¡ï¼›
4. **Arc + Mutex**ï¼šåœ¨å¤šä¸ªçº¿ç¨‹é—´å®‰å…¨å…±äº«æ•°æ®ï¼›
5. **å‘½ä»¤è¡Œå‚æ•°è§£æ**ï¼šé€šè¿‡ `clap` æˆ–ç±»ä¼¼åº“æ”¯æŒä¼ å…¥åˆå§‹è¿æ¥åœ°å€ã€‚

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. `libp2p::Swarm` åˆå§‹åŒ–ä¸è¡Œä¸ºå®šä¹‰

```rust
let mut swarm = SwarmBuilder::new(...)
```

- ä½¿ç”¨ `libp2p::swarm::SwarmBuilder` æ„å»ºä¸€ä¸ª `Swarm` å®ä¾‹ã€‚
- æŒ‡å®šç½‘ç»œè¡Œä¸ºä¸ºåŒ…å«ä»¥ä¸‹åè®®çš„ç»„åˆè¡Œä¸ºï¼š
  - **Identify åè®® (`Identify`)**
    - è‡ªåŠ¨è¯†åˆ«è¿æ¥å¯¹ç­‰èŠ‚ç‚¹çš„ä¿¡æ¯ï¼ˆå¦‚ PeerIdã€ç›‘å¬åœ°å€ï¼‰ï¼›
  - **mDNS åè®® (`mdns`)**
    - æ”¯æŒå±€åŸŸç½‘è‡ªåŠ¨å‘ç°æœ¬åœ°ç½‘ç»œä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼›
  - **Kademlia DHT åè®® (`kad`)**
    - å®ç°åˆ†å¸ƒå¼å“ˆå¸Œè¡¨ï¼Œç”¨äºå­˜å‚¨å’ŒæŸ¥æ‰¾é”®å€¼å¯¹ï¼Œå¸¸ç”¨äºèŠ‚ç‚¹å‘ç°å’Œå†…å®¹å¯»å€ã€‚

### 2. è¿è¡Œæ—¶çŠ¶æ€ç®¡ç† `P2pStatus`

```rust
struct P2pStatus {
    peer_id: PeerId,
    listen_addrs: Vec<Multiaddr>,
    kbucket_peers: HashMap<PeerId, Vec<Multiaddr>>,
}
```

- å­˜å‚¨å½“å‰èŠ‚ç‚¹çš„åŸºæœ¬ä¿¡æ¯ï¼š
  - `peer_id`: å½“å‰èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†ï¼›
  - `listen_addrs`: å½“å‰ç›‘å¬åœ°å€åˆ—è¡¨ï¼›
  - `kbucket_peers`: Kademlia è·¯ç”±è¡¨ä¸­å·²çŸ¥çš„èŠ‚ç‚¹åŠå…¶åœ°å€ã€‚

> æ­¤ç»“æ„ä½“è¢«å°è£…åœ¨ `Arc<Mutex<P2pStatus>>` ä¸­ï¼Œç¡®ä¿åœ¨å¼‚æ­¥ä»»åŠ¡å’Œ Web æ¥å£ä¹‹é—´å¯ä»¥å®‰å…¨åœ°è¯»å†™ã€‚

### 3. å¼‚æ­¥ä¸»å¾ªç¯å¤„ç† `SwarmEvent`

```rust
loop {
    select! {
        event = swarm.select_next_some() => match event {
            SwarmEvent::NewListenAddr { address, .. } => {
                // æ›´æ–°ç›‘å¬åœ°å€
            }
            SwarmEvent::Behaviour(BehaviourEvent::Identify(event)) => {
                // å¤„ç† Identify äº‹ä»¶ï¼Œæ›´æ–°è¿œç¨‹èŠ‚ç‚¹ä¿¡æ¯
            }
            SwarmEvent::Behaviour(BehaviourEvent::Mdns(event)) => {
                // å¤„ç† mDNS å‘ç°çš„èŠ‚ç‚¹
            }
            SwarmEvent::Behaviour(BehaviourEvent::Kad(event)) => {
                // å¤„ç† Kademlia æŸ¥è¯¢ç»“æœæˆ–æ’å…¥äº‹ä»¶
            }
            _ => {}
        },
        ...
    }
}
```

- ä¸»å¾ªç¯ä½¿ç”¨ `select!` å®åŒæ—¶ç›‘å¬å¤šä¸ªå¼‚æ­¥äº‹ä»¶æºï¼›
- `SwarmEvent` æ˜¯ libp2p çš„æ ¸å¿ƒäº‹ä»¶ç±»å‹ï¼ŒåŒ…æ‹¬ï¼š
  - æ–°å¢ç›‘å¬åœ°å€ï¼›
  - å»ºç«‹æ–°è¿æ¥ï¼›
  - åè®®äº‹ä»¶ï¼ˆå¦‚ Identifyã€mDNSã€Kademliaï¼‰ï¼›
- æ¯ä¸ªäº‹ä»¶è§¦å‘åä¼šæ›´æ–° `P2pStatus` å…±äº«çŠ¶æ€ã€‚

### 4. å¯åŠ¨ HTTP æ¥å£ `/status`

```rust
HttpServer::new(move || {
    let status = Arc::clone(&p2p_status);
    App::new()
        .wrap(middleware::Logger::default())
        .data(status)
        .route("/status", web::get().to(status_handler))
})
.bind("127.0.0.1:8080")?
.run()
.await?;
```

- ä½¿ç”¨ `actix-web` åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼›
- æä¾› `/status` æ¥å£ï¼Œè¿”å›å½“å‰èŠ‚ç‚¹çš„ JSON çŠ¶æ€ä¿¡æ¯ï¼›
- æ¥å£å¤„ç†å™¨ `status_handler` ä» `p2p_status` ä¸­è¯»å–æœ€æ–°çŠ¶æ€å¹¶åºåˆ—åŒ–è¿”å›ã€‚

### 5. å‘½ä»¤è¡Œå‚æ•°æ”¯æŒä¸»åŠ¨è¿æ¥èŠ‚ç‚¹

```rust
if let Some(addr) = args.connect.as_ref() {
    let remote_addr: Multiaddr = addr.parse()?;
    swarm.dial(remote_addr)?;
}
```

- å¦‚æœå¯åŠ¨æ—¶ä¼ å…¥äº† `--connect <multiaddr>` å‚æ•°ï¼Œåˆ™å°è¯•æ‹¨å·è¿æ¥æŒ‡å®šèŠ‚ç‚¹ï¼›
- ä½¿ç”¨ `swarm.dial()` å»ºç«‹è¿æ¥ï¼›
- æˆåŠŸè¿æ¥åä¼šè§¦å‘åç»­çš„ Identifyã€Kademlia ç­‰äº‹ä»¶ã€‚

---

## ğŸ§ª å¯èƒ½çš„åŠŸèƒ½æ‰©å±•æ–¹å‘

- å®ç° Gossipsub åè®®è¿›è¡Œæ¶ˆæ¯å¹¿æ’­ï¼›
- æ·»åŠ æ–‡ä»¶åˆ†å‘åŠŸèƒ½ï¼ˆä¾‹å¦‚ IPFS é£æ ¼çš„å†…å®¹å¯»å€ï¼‰ï¼›
- å°† Kademlia DHT ç”¨ä½œå…¨å±€æ³¨å†Œè¡¨ï¼›
- å®ç° TLS åŠ å¯†é€šä¿¡ï¼›
- æ·»åŠ  CLI å·¥å…·ç”¨äºå‘é€æ§åˆ¶æŒ‡ä»¤ã€‚

---

## ğŸ“¦ ç¤ºä¾‹å“åº” `/status`

```json
{
  "peer_id": "QmXxx...",
  "listen_addrs": ["/ip4/0.0.0.0/tcp/59685"],
  "kbucket_peers": {
    "QmYyy...": ["/ip4/192.168.1.2/tcp/59685"]
  }
}
```

---

## âœ… æŠ€æœ¯äº®ç‚¹æ€»ç»“

| åŠŸèƒ½ | æŠ€æœ¯é€‰å‹ |
|------|----------|
| P2P é€šä¿¡ | `libp2p-rs` |
| èŠ‚ç‚¹å‘ç° | `Identify`, `mDNS`, `Kademlia` |
| çŠ¶æ€å…±äº« | `Arc<Mutex<T>>` |
| HTTP æ¥å£ | `actix-web` |
| å¼‚æ­¥è¿è¡Œæ—¶ | `tokio` |

---

å¦‚æœä½ æœ‰å…·ä½“çš„ä»£ç ç‰‡æ®µéœ€è¦æ›´æ·±å…¥åˆ†æï¼Œæ¬¢è¿è´´å‡ºä»£ç ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥é€è¡Œè§£è¯»ã€‚